# https://github.com/docker-library/postgres/tree/master/9.3
db:
  image: postgres:9.3
  environment:
    - POSTGRES_USER=yabiapp
    - POSTGRES_PASSWORD=yabiapp
  ports:
    - "5432:5432"

mq:
  image: tutum/rabbitmq
  environment:
    - RABBITMQ_PASS=admin
  ports:
    - "5672:5672"
    - "15672:15672"

cache:
  image: memcached
  expose:
    - "11211"

nginx:
  image: nginx:1.7
  volumes:
    - nginx:/etc/nginx
  links:
    - uwsgi
  expose:
    - "8443"
  ports:
    - "443:8443"

web:
  build: .
  command: runserver
  environment:
    - QUEUESERVER=mq
    - QUEUEPORT=5672
    - DJANGO_SETTINGS_MODULE=yabiadmin.settings
    - CELERY_BROKER=amqp://admin:admin@mq:5672//
    - DBSERVER=db
    - DBPORT=5432
    - DBUSER=yabiapp
    - DBPASS=yabiapp
    - DBNAME=yabiapp
    - WRITABLE_DIRECTORY=/data
    - LOG_DIRECTORY=/data/log
  volumes:
    - .:/app
  ports:
    - "8000:8000"
  links:
    - db
    - mq
    - cache

uwsgi:
  image: yabi_web
  command: uwsgi
  environment:
    - QUEUESERVER=mq
    - QUEUEPORT=5672
    - DBSERVER=db
    - DBPORT=5432
  volumes:
    - .:/app
  ports:
    - "9000:9000"
    - "9001:9001"
    - "9100:9100"
    - "9101:9101"
  links:
    - db
    - mq
    - cache

# Create a celery container using the yabi_uwsgi container from above
# Passing through the celery command invokes celery
# Work in progress
celery:
  image: yabi_web
  command: celery
  environment:
    - QUEUESERVER=mq
    - QUEUEPORT=5672
    - CELERY_BROKER=amqp://admin:admin@mq:5672//
    - CELERY_APP=yabiadmin.backend.celerytasks
    - CELERY_AUTORELOAD=1
    - DJANGO_SETTINGS_MODULE=yabiadmin.settings
    - DBSERVER=db
    - DBPORT=5432
    - DBUSER=yabiapp
    - DBPASS=yabiapp
    - WRITABLE_DIRECTORY=/data
    - LOG_DIRECTORY=/data/log
  volumes:
    - .:/app
  links:
    - db
    - mq
