# data only container pattern
data:
  image: muccg/base:debian8
  volumes:
    - .:/app

ssh:
  image: muccg/ssh
  hostname: ssh

db:
  image: postgres:9.3
  environment:
    - POSTGRES_USER=yabiapp
    - POSTGRES_PASSWORD=yabiapp
  ports:
    - ":5432"

mq:
  image: dockerfile/rabbitmq:latest
  ports:
    - ":5672"
    - ":15672"

cache:
  image: memcached:1.4

nginx:
  image: muccg/nginx-uwsgi:1.7
  links:
    - uwsgi
  ports:
    - "8443:443"

web:
  build: .
  command: runserver
  environment:
    - DJANGO_SETTINGS_MODULE=yabiadmin.settings
    - DBUSER=yabiapp
    - WAIT_FOR_QUEUE=1
    - WAIT_FOR_DB=1
    - WAIT_FOR_CACHE=1
    - WAIT_FOR_SSH=1
  volumes_from:
    - data
  ports:
    - "8000:8000"
  links:
    - db
    - mq
    - cache
    - ssh

uwsgi:
  image: yabi_web
  command: uwsgi
  environment:
    - DJANGO_SETTINGS_MODULE=yabiadmin.settings
    - DBUSER=yabiapp
    - WAIT_FOR_QUEUE=1
    - WAIT_FOR_DB=1
    - WAIT_FOR_CACHE=1
    - WAIT_FOR_SSH=1
    - WAIT_FOR_WEB=1
      # note: uwsgi ini file sets environment
  volumes_from:
    - data
  ports:
    - "9000:9000"
    - "9001:9001"
    - "9100:9100"
    - "9101:9101"
  links:
    - db
    - mq
    - cache
    - ssh
    - web

celery:
  image: yabi_web
  command: celery
  hostname: celery
  environment:
    - DJANGO_SETTINGS_MODULE=yabiadmin.settings
    - CELERY_APP=yabiadmin.backend.celerytasks
    - CELERY_AUTORELOAD=1
    - DBUSER=yabiapp
    - WAIT_FOR_QUEUE=1
    - WAIT_FOR_DB=1
    - WAIT_FOR_SSH=1
  volumes_from:
    - data
  links:
    - db
    - mq
    - ssh
