# data only container pattern
datastaging:
  image: muccg/debian8-base:latest
  volumes:
    - data:/data

sshstaging:
  image: muccg/ssh:latest
  hostname: sshstaging
  volumes_from:
    - datastaging

s3staging:
  image: muccg/fake-s3:latest

dbstaging:
  image: postgres:9.3
  environment:
    - POSTGRES_USER=yabiapp
    - POSTGRES_PASSWORD=yabiapp
  ports:
    - ":5432"

mqstaging:
  image: rabbitmq:management
  ports:
    - ":5672"
    - ":15672"

cachestaging:
  image: memcached:1.4

webstaging:
  build: docker/unstable/
  command: uwsgi
  environment:
    - DJANGO_SETTINGS_MODULE=yabi.settings
    - DBSERVER=dbstaging
    - DBUSER=yabiapp
    - QUEUESERVER=mqstaging
    - CACHESERVER=cachestaging
    - SSHSERVER=sshstaging
    - S3SERVER=s3staging
    - WAIT_FOR_QUEUE=1
    - WAIT_FOR_DB=1
    - WAIT_FOR_CACHE=1
    - WAIT_FOR_SSH=1
    - WAIT_FOR_S3=1
  volumes_from:
    - datastaging
  ports:
    - "9200:9100"
    - "9201:9101"
  links:
    - dbstaging
    - mqstaging
    - cachestaging
    - sshstaging
    - s3staging

celerystaging:
  image: yabi_webstaging
  hostname: celerystaging
  command: celery
  environment:
    - DJANGO_SETTINGS_MODULE=yabi.settings
    - CELERY_APP=yabi.backend.celerytasks
    - DBSERVER=dbstaging
    - DBUSER=yabiapp
    - QUEUESERVER=mqstaging
    - CACHESERVER=cachestaging
    - SSHSERVER=sshstaging
    - S3SERVER=s3staging
    - WAIT_FOR_QUEUE=1
    - WAIT_FOR_DB=1
    - WAIT_FOR_SSH=1
    - WAIT_FOR_S3=1
  volumes_from:
    - datastaging
  links:
    - dbstaging
    - mqstaging
    - cachestaging
    - sshstaging
    - s3staging
