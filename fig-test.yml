sshtest:
  image: muccg/ssh:latest
  hostname: ssh

s3test:
  image: muccg/fake-s3:latest
        
dbtest:
  image: postgres:9.3
  environment:
    - POSTGRES_USER=yabiapp
    - POSTGRES_PASSWORD=yabiapp
  ports:
    - ":5432"

mqtest:
  image: rabbitmq:3-management
  environment:
    - RABBITMQ_NODENAME=yabi        
  ports:
    - ":5672"
    - ":15672"

cachetest:
  image: memcached:1.4

webtest:
  image: yabi_web
  command: runserver
  environment:
    - DJANGO_SETTINGS_MODULE=yabiadmin.settings
    - DBSERVER=dbtest
    - DBUSER=yabiapp
    - QUEUESERVER=mqtest
    - CACHESERVER=cachetest
    - SSHSERVER=sshtest
    - S3SERVER=s3test
    - WAIT_FOR_QUEUE=1
    - WAIT_FOR_DB=1
    - WAIT_FOR_CACHE=1
    - WAIT_FOR_SSH=1
    - WAIT_FOR_S3=1
  volumes:
    - .:/app
  ports:
    - ":8000"
  links:
    - dbtest
    - mqtest
    - cachetest
    - sshtest
    - s3test

celerytest:
  image: yabi_web
  hostname: celery
  command: celery
  environment:
    - DJANGO_SETTINGS_MODULE=yabiadmin.settings
    - CELERY_APP=yabiadmin.backend.celerytasks
    - CELERY_AUTORELOAD=1
    - DBSERVER=dbtest
    - DBUSER=yabiapp
    - QUEUESERVER=mqtest
    - SSHSERVER=sshtest
    - S3SERVER=s3test
    - WAIT_FOR_QUEUE=1
    - WAIT_FOR_DB=1
    - WAIT_FOR_SSH=1
    - WAIT_FOR_S3=1
  volumes_from:
    - webtest
  links:
    - dbtest
    - mqtest
    - sshtest
    - s3test

# runs the tests against the stack above
testhost:
  image: yabi_web
  command: runtests
  environment:
    - DJANGO_SETTINGS_MODULE=yabiadmin.settings
#    - TEST_CASES=tests.simple_tool_tests
    - DBSERVER=dbtest
    - DBUSER=yabiapp
    - QUEUESERVER=mqtest
    - WEBSERVER=webtest
    - SSHSERVER=sshtest
    - S3SERVER=s3test
    - WAIT_FOR_QUEUE=1
    - WAIT_FOR_DB=1
    - WAIT_FOR_WEB=1
    - WAIT_FOR_SSH=1
    - WAIT_FOR_S3=1
  volumes_from:
    - webtest
  links:
    - dbtest
    - webtest
    - mqtest
    - sshtest
    - s3test
