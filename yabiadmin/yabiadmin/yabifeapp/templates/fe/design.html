{% extends "fe/base.html" %}
{% load static from staticfiles %}

{% block header %}
    <link rel="stylesheet" type="text/css" media="screen" href="{% static 'css/design.css' %}" />

    <script type="text/javascript">
        Y.use('*', function(Y) {
            Y.on('domready', function() {
                initWorkflow();
            });
        });

        var workflow;
        var tools;

        function initWorkflow() {
            var reusing = false;
            {% if reuseId %}
                reusing = true;
            {% endif %}
            tools = new YabiToolCollection();
            
            document.getElementById("toolContainer").appendChild(tools.containerEl);
            
            workflow = new YabiWorkflow(true, reusing);

            if (reusing) {
              workflow.hydrate({{reuseId}});
              workflow.workflowId = undefined;
            }
            
            var updateFilter = function(job) {
                if (!tools.autofilter) {
                    return;
                }

                if (job === null) {
                    tools.searchEl.value = "";
                } else {
                    tools.searchEl.value = "in:" + job.emittedFileTypes();
                }
                tools.filter();

                // Resize the file selector to roughly fit the available space.
                var fs = document.querySelector(".fileSelector");
                var height = Yabi.util.getViewportHeight();
                if (fs && height) {
                    var top = Yabi.util.getElementOffset(fs).top;

                    // The 30 pixels is pure, unadulterated fudge factor.
                    var height = height - top - 30;

                    fs.querySelector(".fileSelectorBrowse").style.minHeight = height + "px";
                }
            };

            workflow.afterSelectJob = updateFilter;
            workflow.afterPropagate = updateFilter;
            
            document.getElementById("container").appendChild(workflow.mainEl);
            document.getElementById("optionsDiv").appendChild(workflow.optionsEl);
            
            Y.one("#submitButton").on("click", submitCallback, null, workflow);
        }

        //this function is used after a workflow is submitted, 
        //and after the tags have been saved, 
        //to redirect the browser to view this particular workflow using a hashtag
        var summonJobsView = function(workflowId) {
            window.location = appURL + 'jobs#' + workflowId;
        };

        function submitCallback(e, wf) {
            
            // TODO add decent callbacks
            e.halt(true);
            
            if (!wf.isValid()) {
                YAHOO.ccgyabi.widget.YabiMessage.fail("Workflow isn't valid. Please correct errors before submitting.");
            } else {

                var baseURL = appURL + "ws/workflows/submit/";
                
                jsCallback = {
                    success: function (transId, obj, args) {
                        YAHOO.ccgyabi.widget.YabiMessage.success("Success on submit!");
                        workflow.submitSuccessCallback(obj, summonJobsView, args.target);
                    },
                    failure: function (transId, obj) {
                        YAHOO.ccgyabi.widget.YabiMessage.fail("Fail on submit!");
                    }
                };
                var data = "username={{request.user.username}}&workflowjson=" + encodeURIComponent(wf.toJSON());
                var cfg = {
                    method: 'POST',
                    on: jsCallback,
                    data: data,
                    "arguments": {
                        target: wf
                    }
                };
                jsTransaction = Y.io(baseURL, cfg);
            }
        }

        function summonJob(toolName) {
            workflow.addJob(toolName);
        }

        function destroyWorkflow() {
            workflow.destroy();
            return false;
        }
    </script>
{% endblock %}

{% block body %}
    <div id="doc3" class="yui-t1">
        <div id="yabi-design-mode">
            {% block bodyhd %}
            {{ block.super }}
            {% endblock %}

            <div class="yabiLeftColumn">
                <div id="toolContainer"></div>
            </div>
            <div class="yabiMiddleColumn">
                <div id="container"></div>
            </div>
            <div class="yabiRightColumn">
                <div id="optionsDiv"></div>
            </div>
        </div>
    </div>
  
{% endblock %}
